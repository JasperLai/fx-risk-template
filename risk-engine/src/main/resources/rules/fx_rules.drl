package rules;
import java.math.BigDecimal;
import com.bank.risk.common.dto.FxRiskReq;
import com.bank.risk.common.dto.OrderType;
import com.bank.risk.feature.FeatureService;
import com.bank.risk.common.dto.Decision;
import com.bank.risk.common.model.RuleHit;

global java.util.List hits;
global java.util.concurrent.atomic.AtomicReference decisionRef;

rule "R_CROSS_RATIO_EURJPY" salience 95
when
  $ctx: FxRiskReq( symbol == "EURJPY" )
  $feat: FeatureService()
then
  BigDecimal eurusd = $feat.mid("EURUSD");
  BigDecimal usdjpy = $feat.mid("USDJPY");
  BigDecimal m = $feat.mid("EURJPY");
  if(eurusd!=null && usdjpy!=null && m!=null){
    BigDecimal theo = eurusd.multiply(usdjpy);
    BigDecimal dev = m.subtract(theo).abs().divide(theo, 8, java.math.RoundingMode.HALF_UP);
    if(dev.compareTo(new BigDecimal("0.0015"))>0){
      hits.add(new RuleHit("R_CROSS_RATIO_EURJPY", "dev=" + dev));
      if (decisionRef.get().compareTo(Decision.REVIEW) < 0) {
        decisionRef.set(Decision.REVIEW);
      }
    }
  }
end

rule "R_PER_ORDER_LIMIT" salience 90
when
  $ctx: FxRiskReq( type == OrderType.ORDER, $sym: symbol, $ten: tenor, $qty: qty )
then
  java.math.BigDecimal limit = new java.math.BigDecimal($ten.equals("SPOT")?"5000000":"3000000");
  if($qty!=null && $qty.compareTo(limit)>0){
    hits.add(new RuleHit("R_PER_ORDER_LIMIT", "qty>" + limit));
    if (decisionRef.get().compareTo(Decision.REVIEW) < 0) {
      decisionRef.set(Decision.REVIEW);
    }
  }
end

rule "R_ARB_PNL_WARN" salience 85
when
  $ctx: FxRiskReq( )
  $feat: FeatureService()
then
  if($feat.pnlArb("deskDefault", 3600).compareTo(new BigDecimal("-20000"))<0){
    hits.add(new RuleHit("R_ARB_PNL_WARN", "arbPnL<warn"));
    if (decisionRef.get().compareTo(Decision.REVIEW) < 0) {
      decisionRef.set(Decision.REVIEW);
    }
  }
end

rule "R_NET_EXPOSURE_LIMIT" salience 80
when
  $ctx: FxRiskReq( $sym: symbol, $ten: tenor, $book: book )
  $feat: FeatureService()
then
  BigDecimal ne = $feat.netExposureUsd($sym,$ten,$book);
  BigDecimal lim = new BigDecimal("10000000");
  if(ne.compareTo(lim)>0){
    hits.add(new RuleHit("R_NET_EXPOSURE_LIMIT", "ne>" + lim));
    if (decisionRef.get().compareTo(Decision.DENY) < 0) {
      decisionRef.set(Decision.DENY);
    }
  }
end

rule "R_PASSIVE_HEDGE_PNL" salience 70
when
  $ctx: FxRiskReq( type == OrderType.ORDER )
  $feat: FeatureService()
then
  BigDecimal slip = $feat.hedgeSlippage($ctx.symbol(), String.valueOf(System.currentTimeMillis()/1000));
  if(slip!=null && slip.compareTo(new BigDecimal("0.0008"))>0){
    hits.add(new RuleHit("R_PASSIVE_HEDGE_PNL", "slip>0.0008"));
    if (decisionRef.get().compareTo(Decision.REVIEW) < 0) {
      decisionRef.set(Decision.REVIEW);
    }
  }
end

rule "R_PNL_LOCK" salience 60
when
  $ctx: FxRiskReq( )
  $feat: FeatureService()
then
  if ($feat.pnlToday("deskDefault").compareTo(new BigDecimal("-100000")) < 0) {
    hits.add(new RuleHit("R_PNL_LOCK", "pnlToday<lock"));
    if (decisionRef.get().compareTo(Decision.LOCK) < 0) {
      decisionRef.set(Decision.LOCK);
    }
  }
end
